on:
  pull_request:
    branches:
      - main
jobs:
  test-unit:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - run: |
          export GOPATH=$HOME/go && \
          export GOBIN=$GOPATH/bin && \
          export PATH=$GOBIN:$PATH:/usr/local/go/bin && \
          make clean test-unit
  test-fail:
    runs-on: self-hosted
    steps:
      - name: test Fail
        run: |
          exit 1
  job10:
    runs-on: self-hosted
    needs: [test-unit, test-fail]
    if: (needs.test-unit.result == 'success' || needs.test-fail.result == 'success')
    steps:
      - name: env var for PR link
        run: |
          echo "GET_REF=${{github.ref}} | sed -E 's/^refs\/pull\/(.*)\/merge$/\1/'" >> $GITHUB_ENV
          echo "${{env.GET_REF}}"
          echo "GET_PR_URL='https://github.com/${{ github.actor }}/app/pull/${{env.GET_REF}}'" >> $GITHUB_ENV
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: coincover-devops-alert
          SLACK_COLOR: ${{ job.status }}
          SLACK_ICON: https://assets.coincover.com/images/logo-square.png
          SLACK_TITLE: 'Message :partyparrot: '
          SLACK_MESSAGE: '@here All checks have passed :white_check_mark:! Review pull request using the link ${{env.GET_PR_URL}}'
          SLACK_USERNAME: Github
          MSG_MINIMAL: event,actions url,ref
          SLACK_LINK_NAMES: true
          SLACK_WEBHOOK: ${{ secrets.SLACKWEBHOOK }}
          SLACK_MSG_AUTHOR: ${{ github.actor }}
  run-if-failed:
    runs-on: self-hosted
    needs: [test-unit, test-fail]
    if: always() && (needs.test-unit.result == 'failure' || needs.test-fail.result == 'failure')
    steps:
      - name: env var for PR link
        run: |
          echo "GET_REF=${{github.ref}} | sed -E 's/^refs\/pull\/(.*)\/merge$/\1/'" >> $GITHUB_ENV
          echo "${{env.GET_REF}}"
          echo "GET_PR_URL='https://github.com/${{ github.actor }}/app/pull/${{env.GET_REF}}'" >> $GITHUB_ENV
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_CHANNEL: coincover-devops-alert
          SLACK_COLOR: '#CC0000'
          SLACK_ICON: https://assets.coincover.com/images/logo-square.png
          SLACK_TITLE: 'Message :fire::fire::fire:'
          SLACK_MESSAGE: '@here Something failed :x:! Review pull request using the link ${{env.GET_PR_URL}}'
          SLACK_USERNAME: Github
          MSG_MINIMAL: event,actions url,ref
          SLACK_LINK_NAMES: true
          SLACK_WEBHOOK: ${{ secrets.SLACKWEBHOOK }}
          SLACK_MSG_AUTHOR: ${{ github.actor }}
